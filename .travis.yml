language: python
python:
- '2.7'
services:
- docker

before_install:
  - sudo apt-get -qq update
  - sudo apt-get -y install autoconf automake build-essential libass-dev libfreetype6-dev
    libtheora-dev libtool libva-dev libvdpau-dev libvorbis-dev libxcb1-dev libxcb-shm0-dev
    libxcb-xfixes0-dev pkg-config texinfo wget zlib1g-dev
  - sudo apt-get -y install yasm nasm libmp3lame-dev
  - mkdir ~/ffmpeg_sources
  - cd ~/ffmpeg_sources
  - wget http://ffmpeg.org/releases/ffmpeg-snapshot.tar.bz2
  - tar jxf ffmpeg-snapshot.tar.bz2
  - cd ffmpeg
  - PATH="$HOME/bin:$PATH" PKG_CONFIG_PATH="$HOME/ffmpeg_build/lib/pkgconfig" ./configure
    --prefix="$HOME/ffmpeg_build" --pkg-config-flags="--static" --extra-cflags="-I$HOME/ffmpeg_build/include"
    --extra-ldflags="-L$HOME/ffmpeg_build/lib" --bindir="$HOME/bin" --enable-libmp3lame
  - PATH="$HOME/bin:$PATH" make -s -j
  - make install
  - hash -r
  - cd $TRAVIS_BUILD_DIR
  - "/sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile
    --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1280x1024x16"

install:
  - pip install -r requirements.txt

before_script:
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - sleep 3

script:
  - coverage run -m unittest discover

after_success:
  - cd $TRAVIS_BUILD_DIR
  - coveralls

before_deploy:
  - docker pull ubuntu:16.04
  - docker build --build-arg TRAVIS_TAG=${TRAVIS_TAG} -t osl_image .
  - docker create --name osl_container osl_image
  - docker cp osl_container:/app/deb_dist/ .
  - cd deb_dist
  - debsign -S -k${KEYID} openscreenlapser_*_source.changes
  - dput ppa:tybantarnusa/ppa openscreenlapser_*_source.changes

deploy:
  provider: releases
  api_key:
    secure: rK3FY84xnx7gM8fgwXsfySxE7rdsQEwFEAGk/ln8lHFQZfGWd+ZBmtN+U7y68GG2GzjMFg85GA449/hS9LRVKDxkC7ewY2WS5Lb6Awl4E9dLdpyQCAJdfXerNMa45bHTiqCqPlpyoR2zpQhpzPZLPfv65Mj1rOe4yAwTFTXyFbURtHHbVcGd8pK0bSKt8eBL451J2rxYgB2MEsxvtA+KADg3Qkjynss4eSvG3R8fQwnupJ7mCJGqvKvQDp3ZhTE/cfIxwPrMNgOpo7llvb9An6T/pgtNvK2k/MYAVhSJxW7Y83D1N3HN1HKVkVhVEglrUavdhUUHokAenM4lR3FAYSiN2xH7gaY9VaE78syiuF5tXejfilpxnGlgSQqgSQkEKcq3Dxbt3MEVHRdJa9Apaq3fTvXrDuZ1i4FycnMYzR9JtqYDVc73ubUZdBEO8LufP4iDn/U1Iq7+3Vo8UqadfxhONhUFBdjpTG/tkLjiDJtCTjpHPQMe2RPYGWiv/LUw61l8Mvv6EnDg4pU3hRc1BS3GLe8IRApN+tBax35cMN2ufsGkHuXsXo4sh51EoVNzBzaniuwojSXxS99R7FJ4J6Rp9JowE3AqNWx6Uui9XvfFWLo59GnZA+tli/NqDI0xnZnCCr1Q5f/c37fuwGIY3RFxVTvLdP1oS9JOYOEQUVc=
  file_glob: true
  file: deb_dist/openscreenlapser_*.deb
  skip_cleanup: true
  on:
    repo: tybantarnusa/openscreenlapser
    branch: master
    tags: true

env:
  global:
    secure: VSFR9g/tqceVqufla4bhS+XzwAx67DS+D0x38vNKbn7EG99owvpZw/7YeJOZjBLE42l8hOfnww1Pu1paxZkm2cFVqebGhMzkRn3Mvkv9Yj57KuaCvFXGlM2SSy7KNaFRyrm+2gLj3n47lqPOd+KinW3pR2zf+EI+3gx1ExgHPELN2kwfUzgHe9aP7h1eQGe4fdrDzF3sVZ+TznCpoYzuwB8BLAOoDIkR0sYAN/I6lEwN5jxaae8vhwQ7oZ2/0YxL6rkSTEMrFYjDrgLH/ZJJiKi6VyP25p0FZsJl9llQRg/vpGK1MCL0k7aK9+GLuPUf9MTZsw4wC3BpbK5TrjxdCVrX/7UV2/agF/TvT+Zo1R3+bS5KwzUIh4EPIvmXW84hewwgM9IZmX+nK6rMdv28fsZL6/6pfvn+iKtUYZMR9wL3BVfXKvhuDD4WxDbXYTA8SeIxgQFfl0TPNoLwECHIVBwLP7wyJuclO6+sIMrWiko/0xAYPKcrPrTE80eCZQCXeE6DK7Bd56EcfT7adGPUhTaBAzDdqUcuWRDiOnYyviv6iBOw28S16LoZhTX07MiP0WWoyjz7VRovGQLAFdfn69do5ZOBlCkG74q2NMPBk3jacJTRFtib175hoFOhCpi1k4fFRVatrAvoUskewxYrg8QQujuAlC7VzErNWrFgoeY=
